<!DOCTYPE html>

<html lang="en">
<head>
    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <script type="text/ecmascript" src="js/jquery.min.js"></script> 
    <!-- This is the Javascript file of jqGrid -->   
    <script type="text/ecmascript" src="js/trirand/jquery.jqGrid.min.js"></script>
    <!-- This is the localization file of the grid controlling messages, labels, etc.
    <!-- We support more than 40 localizations -->
    <script type="text/ecmascript" src="js/trirand/i18n/grid.locale-en.js"></script>
    <!-- A link to a jQuery UI ThemeRoller theme, more than 22 built-in and many more custom -->
    <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.css" />
    <!-- The link to the CSS that the grid needs -->
    <link rel="stylesheet" type="text/css" media="screen" href="css/trirand/ui.jqgrid.css" />
<!--    jquery shits-->
<!--    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">-->
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>The protein DB model grid</title>
</head>
<body>

    <style type="text/css">

        /* set the size of the datepicker search control for Order Date*/
        #ui-datepicker-div { font-size:11px; }
        
        /* set the size of the autocomplete search control*/
        .ui-menu-item {
            font-size: 11px;
        }

         .ui-autocomplete {
            font-size: 11px;
        }
        //ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-draggable ui-resizable{ width: auto; maxwidth: 900px}

    </style>

    <table id="jqGrid"></table>
    <div id="jqGridPager"></div>
    <div id="pvDialog" title="PV" hidden >
        <!--<iframe id="pvDialogFrame" src="js/pv/index.html" width="600" height="500"></iframe>-->
        <iframe id="pvDialogFrame" width="600" height="500"></iframe>
    </div>
    <input type="button" value="Download Selected Models" onclick="downloadSelecteds()" />
    <div id="downloader"></div>
<!--    zip scripts-->
<!--    <script type="text/javascript" src="js/zip.js"></script>
    <script type="text/javascript" src="js/simpleZip.js"></script>
    <script type="text/javascript" src="js/FileSaver.js"></script>-->
    <script src="js/jquery-multidownload/jquery-multidownload.js"></script>
    <script type="text/javascript"> 
    
        $(document).ready(function () {
            $("#jqGrid").jqGrid({
                url: 'db/data.json',
                editurl: 'clientArray',
                //mtype: "GET",
                datatype: "json",
                page: 1,
                colModel: [
                    {   label : "id",sorttype: 'integer',name: 'id',key: true,hidden:true,width: 150,editable: true},
                    {   label : "Name",name: 'Name',key: true,width: 150,editable: true},
                    {   label : "Family",name: 'Family',width: 150,editable: true},
                    {   label : "Structure Type",name: 'Structure Type',width: 150,editable: true},
                    {   label : "Organism",name: 'Organism',width:150,editable: true },
                    {   label : "Array",name: 'Array',width: 150,editable: true },
                    {   label : "Description",name: 'Description', width: 150,editable: true,autowidth: true,hidden:true},
                ],
		loadonce: true,
		viewrecords: true,
                width: '150%',
                height: 550,
                rowNum: 10,
                shrinkToFit: true,
                subGrid: true, // set the subGrid property to true to show expand buttons for each row
                subGridRowExpanded: showChildGrid, // javascript function that will take care of showing 
                subGridOptions : {expandOnLoad: false,reloadOnExpand :false,selectOnExpand : true },// expand all rows on load
                pager: "#jqGridPager",
                loadComplete: function() {
//                    var grid = $("#jqGrid");
//                    var subGridCells = $("td.sgcollapsed",grid[0]);
//                    $.each(subGridCells,function(i,value){
//                        if (i!==0) {
//                            $(value).unbind('click').html('');
//                        }
//                    });
                }
            });
			// activate the toolbar searching
            $('#jqGrid').jqGrid('filterToolbar');
	   /* $('#jqGrid').jqGrid('navGrid',"#jqGridPager", {                
                search: true, // show search button on the toolbar
                add: true,
                edit: true,
                del: true,
                refresh: true
            },
                // options for the Edit Dialog
                {
                    editCaption: "The Edit Dialog",
			//		template: template,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Add Dialog
                {
				//	template: template,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Delete Dailog
                {
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                });*/
        });

        //popup3dmodel function
        function show3dModel(pdb){
            //alert(pdb);
            $(function(){$("#pvDialog").dialog();});                    
            //$( "#pvDialog" ).hidden = false;
            
            //$( "#pvDialogFrame" ).attr('src','js/pv/index.html#'+pdb);
            $( "#pvDialog" ).parent().css( "width", "auto");
            $( "#pvDialogFrame").attr('src',"js/jsmol/index.php?pdb="+pdb);
        }
        // the event handler on expanding parent row receives two parameters
        // the ID of the grid tow  and the primary key of the row
        var actualSubGrid = "";
        function showChildGrid(parentRowID, parentRowKey) {
            var childGridID = parentRowID + "_table";
            var childGridPagerID = parentRowID + "_pager";
            //alert(childGridID +" "+ parentRowKey);
            // send the parent row primary key to the server so that we know which grid to show
            var childGridURL = "proteinModels/"+parentRowKey+"/"+parentRowKey+".json";
            //childGridURL = childGridURL + "&parentRowID=" + encodeURIComponent(parentRowKey)
            actualSubGrid = childGridID;
            // add a table and pager HTML elements to the parent grid row - we will render the child grid here
            $('#' + parentRowID).append('<table id=' + childGridID + '></table><div id=' + childGridPagerID + ' class=scroll></div>');

            $("#" + childGridID).jqGrid({
                url: childGridURL,
                mtype: "GET",
                datatype: "json",
                page: 1,
                colModel: [
                    { label:' ',index:'select',name:'select',edittype:'checkbox',hidden:false,editable:true,width:15,search:false,formatter: "checkbox",formatoptions:{disabled:false}},
                    { label: 'ID', name: 'id', key: true, width: 70, editable: true,formatter: formatId },
                    { label: 'Model Type', name: 'Model Type', width: 75, editable: true },
                    { label: 'Evaluator', name: 'Evaluator', width: 75, editable: true },
                    { label: 'Score', name: 'Score', width: 70, editable: true },
                    { label: 'PDB', name: 'PDB', width: '160%', editable: true,formatter: formatLink, autowidth: true },
                    { label: 'PSF', name: 'PSF', width: '150%', editable: true,formatter: formatLink, autowidth: true },
                    { label: "3D Model", name: "PDB",width: 55,align:'center',search:false,editable:false,hidden: false,
                        formatter: function(cellValue, options, rowObject){
                            //$( "#pvDialogFrame" ).attr('src','js/pv/index.html#'+parentRowKey+"/"+cellValue);
                            //$( "#pvDialogFrame" ).attr('src','js/jsmol/index.php?pdb='+parentRowKey+"/"+cellValue);
                            return "<input type='button' value='view' View 3d model' onclick='show3dModel(\""+parentRowKey+"/"+cellValue+"\")'\>";
                        }
                    },
                ],
		loadonce: true,
                width: '100%',
                height: '100%',
                shrinkToFit: false,
                treeGrid: true,
                ExpandColumn: 'Model Type',
                multiselect: true,
                onSelectRow: onSelectRow,
                treeGridModel:"adjacency",
                teedatatype:"json",
                treeReader:{
					"parent_id_field":"parent",
					"level_field":"level",
					"leaf_field":"isLeaf",
					"expanded_field":"expanded",
					"loaded":"loaded",
					"icon_field":"icon"
		},
                loadComplete: function () {
                    var getColumnIndexByName = function(grid, columnName) {
                        var cm = grid.jqGrid('getGridParam', 'colModel'), i, l;
                        for (i = 0, l = cm.length; i < l; i += 1) {
                            if (cm[i].name === columnName) {
                                return i; // return the index
                            }
                        }
                        return -1;
                    };
                    var iCol = getColumnIndexByName($(this), 'select'), rows = this.rows, i,
                        c = rows.length;

                    for (i = 1; i < c; i += 1) {
                        $(('input[type="checkbox"]'),rows[i].cells[iCol]).click(function (e) {
                            var row = $(e.target).closest('tr')[0];
                            var id = row.id,isChecked = $(e.target).is(':checked');
                            var pdb=row.cells[5].firstChild,psf=row.cells[6].firstChild;
                            
//                            alert('clicked on the checkbox in the row with id=' + id +
//                                  '\nNow the checkbox is ' +
//                                  (isChecked? 'checked': 'not checked'));
                            //alert( row.cells[5].toString() );
                            
                            //setDownlodeable(pdb);
                            //alert("pdb: "+pdb);
                            if(pdb !== null)
                                setDownlodeable(isChecked,pdb.valueOf());
//                            if(psf !== null)
//                                setDownlodeable(isChecked,psf.valueOf());
                        });
                    }
                } 
                //pager: "#" + childGridPagerID
            });

            function setDownlodeable(isChecked,pdb) {
                if(pdb !== null)
                {
                    var link = document.createElement("a");
                    link.id=pdb;
                    link.download ='';
                    link.name = pdb;
                    link.href = pdb;
                    link.innerHTML = pdb+" \n";
                    link.className = "pdb";
                    var div = document.getElementById('downloader');
                    //document.write(link);
                    //alert("var: "+link);
                    if(isChecked)
                    {
                        div.appendChild(link);
                        //document.body.appendChild(link);
                        //alert("added: "+pdb);
                    }
                    else
                    {
                        var j=0,l=div.children.length;
                        //alert(j+" "+l);
                        for(j = 0; j < l;j+=1)
                        {
                            //alert("Asdfsdaf");
                            var child=div.children[j].href;
                            //alert(child+"\n"+link+"\n"+( child == link));
                            if( child == link)
                            {
//                                alert("wii!");
                                div.removeChild(div.children[j]);
                            }
                        }
                    }

                    //alert("value: "+div.getElementsByTagName(link.name));
                }
            }
            $("#" + childGridID).jqGrid('filterToolbar');
            /*$("#" + childGridID).jqGrid('navGrid',"#"+childGridPagerID, {      //bottom navbar, commented to disable it          
                search: true, // show search button on the toolbar
                add: true,
                edit: true,
                del: true,
                refresh: true
            },
                // options for the Edit Dialog
                {
                    editCaption: "The Edit Dialog",
			//		template: template,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Add Dialog
                {
				//	template: template,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Delete Dailog
                {
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                }); */   
        //});
            function formatLink(cellValue, options, rowObject) {
                if( cellValue !== '' )
                    return "<a id=\""+cellValue+"\" download href='" +"proteinModels/"+parentRowKey+"/"+ cellValue + "'>"+cellValue+ "</a>";
                else
                    return '';
            };
            
            function formatId(cellValue, options, rowObject) {
                return parseInt(cellValue).toString(36);
            };
        }
        
        function downloadSelecteds()
        {
            //$('.pdb').multiDownload('click',{delay: 10000,type: "adownload"});
            $('.pdb').multiDownload();
        }
        function downloadSelectedRows() {
            //cleaning div helper
            var div = document.getElementById('downloader');
            div.innerHTML = "";
            var grid = $("#jqGrid");
            //alert(actualSubGrid);
            //alert(grid);
            grid = $("#"+actualSubGrid);
            //alert(grid);
            var rowKey = grid.getGridParam("selrow");

            if (!rowKey)
                alert("No rows are selected");
            else {
                var selectedIDs = grid.getGridParam("selarrrow");
                var result = "";
                for (var i = 0; i < selectedIDs.length; i++) {
                    result += selectedIDs[i] + ",";
                    //var cell;
                    //alert (cell = grid.getCell(selectedIDs[i],'PDB'));
                    //a = grid.getCell(selectedIDs[i],'PDB');
                    var a = document.getElementById(selectedIDs[i]); //.click();
                    //alert("value "+a);                   
                    if(a.cells[5].firstChild !== null)
                        fileDownload(a.cells[5].firstChild.valueOf());
                    if(a.cells[6].firstChild !== null)
                    {
//                        alert("value 2: "+a.cells[6]);
//                        alert("value 2:"+a.cells[6].firstChild.valueOf() );
                        fileDownload(a.cells[6].firstChild.valueOf());
                    }
                    //$("#"+selectedIDs[i]).click();
                }
                $('.pdb').multiDownload();
//                alert(result);
            }
        }
        //This function create a temp a element marked as downlodeable for multidownload plugin
        function fileDownload(uri)
        {
            var link = document.createElement("a");
            //link.download = uri;
            link.href = uri;
            link.className = "pdb";
            var div = document.getElementById('downloader');
            //document.write(link);
            //alert("var: "+link);
            div.appendChild(link);
            //link.click();
            //event.preventDefault();
            //div.removeChild(link);
                //$("#"+link.id).multiDownload();
        }
        //replaced with a dusty solution
        function onSelectRow(id)
        {
        }
    </script>
</body>
</html>